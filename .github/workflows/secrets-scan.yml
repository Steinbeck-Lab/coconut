name: Secret Leakage Scan

on:
  workflow_call:

permissions:
  contents: read
  security-events: write

concurrency:
  group: secrets-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secrets:
    name: Secret Leakage Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Gitleaks
        run: |
          set -e
          GITLEAKS_VERSION=8.18.4
          curl -sSL -o gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Gitleaks scan
        id: gitleaks
        run: |
          set +e
          gitleaks detect --source . --no-git --redact --report-format sarif --report-path gitleaks.sarif
          code=$?
          echo "$code" > gitleaks-exit-code.txt
          if [ ! -f gitleaks.sarif ]; then
            echo "Gitleaks did not produce SARIF file; creating empty stub." >&2
            printf '%s\n' '{' \
              '  "version": "2.1.0",' \
              '  "runs": [' \
              '    {' \
              '      "tool": { "driver": { "name": "Gitleaks", "informationUri": "https://github.com/gitleaks/gitleaks" } },' \
              '      "results": []' \
              '    }' \
              '  ]' \
              '}' > gitleaks.sarif
          fi
          # Always succeed here; we fail after uploading SARIF for annotations
          exit 0

      - name: Upload SARIF (code scanning)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      - name: Fail if Gitleaks found leaks
        run: |
          code=$(cat gitleaks-exit-code.txt || echo 0)
          if [ "$code" -ne 0 ]; then
            echo "Gitleaks detected potential secrets (exit code $code). Failing job after SARIF upload." >&2
            exit 1
          fi
